{% extends "master_layout.html" %} {% load static %} {% load env_vars %} {%
block content %}

<div class="container mt-5 mb-5" style="min-height: 50vh">
  <div class="d-flex justify-content-between align-items-center">
    <h2 class="mb-4">Proceed to payment</h2>
  </div>
  <div class="my-3">
    <h4>Order Details</h4>
    <p><strong>Order ID:</strong> {{ order.order_id }}</p>
    <p>
      <strong>Order Date:</strong> {{ order.created_at|date:"F j, Y, g:i a" }}
    </p>
    <p><strong>Address:</strong> {{ order.address }}</p>
    <p><strong>Currency:</strong> {{ order.currency }}</p>
    <p><strong>Payment Status:</strong> {{ order.payment_status }}</p>
    <p><strong>Total Amount:</strong> {{ order.currency }} {{ order.total }}</p>
    <p>
      <strong>Amount Paid:</strong> {{ order.currency }} {{ order.amount_paid }}
    </p>
    <p>
      <strong>Amount Due:</strong> {{ order.currency }} {{ order.amount_due }}
    </p>

    <button id="rzp-button" class="btn btn-primary">Make Payment</button>
  </div>
</div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script>
  let options = {
    key: "{% get_env_var 'RAZORPAY_KEY' %}", // Enter the Key ID generated from the Dashboard
    currency: "INR",
    description: "Ice cream shop",
    image: "example.com/image/rzp.jpg",
    order_id: "{{order.razorpay_order_id}}",
    prefill: {
      email: "example@example.com",
      contact: +919900000000,
    },

    handler: function (response) {
      console.log(response);
      alert(response.razorpay_payment_id);

      form = document.createElement("form");

      // Set the form attributes
      form.method = "POST"; // HTTP method to use
      form.action = "{% url 'verify_payment' %}"; // The endpoint to which the data will be sent

      const field0 = document.createElement("input");
      field0.type = "hidden";
      field0.name = "csrfmiddlewaretoken";
      field0.value = "{% csrf_token %}"

      // Add input fields to the form with data
      const field1 = document.createElement("input");
      field1.type = "hidden";
      field1.name = "razorpay_order_id"; // The name of the form field
      field1.value = response.razorpay_order_id; // The value to submit

      const field2 = document.createElement("input");
      field2.type = "hidden";
      field2.name = "razorpay_payment_id";
      field2.value = response.razorpay_payment_id;

      const field3 = document.createElement("input");
      field3.type = "hidden";
      field3.name = "razorpay_signature";
      field3.value = response.razorpay_signature;

      // Append the input fields to the form
      form.appendChild(field1);
      form.appendChild(field2);
      form.appendChild(field3);

      // Append the form to the document body
      document.body.appendChild(form);

      // Automatically submit the form
      form.submit();
    },
    modal: {
      ondismiss: function () {
        if (confirm("Are you sure, you want to close the form?")) {
          txt = "You pressed OK!";
          console.log("Checkout form closed by the user");
        } else {
          txt = "You pressed Cancel!";
          console.log("Complete the Payment");
        }
      },
    },
  };

  var rzp1 = new Razorpay(options);
  document.getElementById("rzp-button").onclick = function (e) {
    rzp1.open();
    e.preventDefault();
  };
</script>
{% endblock %}
